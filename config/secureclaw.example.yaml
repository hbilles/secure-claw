# SecureClaw Configuration
# Phase 6: Multi-provider LLM support

# LLM provider configuration.
# Supported providers: anthropic, openai, lmstudio, codex
#
# Anthropic (default):
#   provider: anthropic
#   model: claude-sonnet-4-20250514
#   Requires ANTHROPIC_API_KEY env var.
#
# OpenAI:
#   provider: openai
#   model: gpt-4o
#   Requires OPENAI_API_KEY env var.
#   Optional: baseURL for Azure OpenAI or other compatible endpoints.
#
# LM Studio (local):
#   provider: lmstudio
#   model: qwen3-235b-a22b        # Must match model loaded in LM Studio
#   No API key needed.
#   Default baseURL: http://host.docker.internal:1234/v1
#   (host.docker.internal resolves to the host machine from inside Docker)
#
# Codex (OpenAI Responses API):
#   provider: codex
#   model: gpt-5-codex             # Codex OAuth mode requires a Codex model
#                                  # (e.g., gpt-5-codex, gpt-5.1-codex, gpt-5.2-codex, gpt-5.3-codex)
#   Auth mode options:
#   - codexAuthMode: api-key (default; requires OPENAI_API_KEY)
#   - codexAuthMode: oauth (requires oauth.openaiCodex.clientId + /connect codex)
#   Optional: baseURL for compatible endpoints.
#   Optional: reasoningEffort: low | medium | high

llm:
  provider: codex
  model: gpt-5-codex
  maxTokens: 4096
  codexAuthMode: oauth

executors:
  shell:
    image: secureclaw-executor-shell
    memoryLimit: 512m
    cpuLimit: 1
    defaultTimeout: 60
    defaultMaxOutput: 1048576  # 1MB

  file:
    image: secureclaw-executor-file
    memoryLimit: 256m
    cpuLimit: 0.5
    defaultTimeout: 30
    defaultMaxOutput: 5242880  # 5MB

  web:
    image: secureclaw-executor-web
    memoryLimit: 1g
    cpuLimit: 2
    defaultTimeout: 120
    defaultMaxOutput: 2097152  # 2MB
    # Web output format:
    # - structured: compact JSON payload for agent consumption
    # - legacy: plain text tree/content output
    resultFormat: structured
    # Domains the web executor is allowed to access (HTTPS only).
    # All other domains are blocked at the DNS level.
    allowedDomains:
      - news.ycombinator.com
      - github.com
      - docs.anthropic.com
      - docs.google.com
      - stackoverflow.com
      - en.wikipedia.org
      - developer.mozilla.org
      - npmjs.com
      - pypi.org

# Mount policies: what host directories are accessible, and how.
# hostPath uses the Docker host's filesystem (~ is resolved at runtime).
# containerPath is the path inside executor containers.
mounts:
  - name: projects
    hostPath: ~/projects
    containerPath: /workspace
    readOnly: false

  - name: documents
    hostPath: ~/Documents
    containerPath: /documents
    readOnly: true

  - name: sandbox
    hostPath: ~/secureclaw-sandbox
    containerPath: /sandbox
    readOnly: false

# Action tiers — HITL approval gates.
# Classification is code-only; the LLM never sees these tiers.
# Rules are checked in order: autoApprove → notify → requireApproval.
# If no rule matches, the default is requireApproval (fail-safe).
#
# Condition keys MUST match the tool input field names exactly
# (e.g., 'path', 'working_directory', 'command').
actionTiers:
  autoApprove:
    - tool: read_file
    - tool: list_directory
    - tool: search_files
    - tool: run_shell_command
      conditions:
        working_directory: /sandbox/**
    # Phase 5: Read-only service tools
    - tool: search_email
    - tool: read_email
    - tool: list_events
    - tool: search_repos
    - tool: list_issues
    - tool: read_file_github
    # Phase 8: Fastmail MCP — read-only operations
    - tool: mcp_fastmail__get_recent_emails
    - tool: mcp_fastmail__get_email
    - tool: mcp_fastmail__get_email_thread
    - tool: mcp_fastmail__search_emails
    - tool: mcp_fastmail__advanced_search
    - tool: mcp_fastmail__list_mailboxes
    - tool: mcp_fastmail__get_mailbox_stats
    - tool: mcp_fastmail__get_account_summary
    - tool: mcp_fastmail__list_contacts
    - tool: mcp_fastmail__get_contact
    - tool: mcp_fastmail__search_contacts
    - tool: mcp_fastmail__list_calendars
    - tool: mcp_fastmail__list_calendar_events
    - tool: mcp_fastmail__get_calendar_event
    - tool: mcp_fastmail__list_identities
    - tool: mcp_fastmail__check_capabilities

  notify:
    - tool: write_file
      conditions:
        path: /sandbox/**
    # Phase 8: Fastmail MCP — low-risk state changes (notify only)
    - tool: mcp_fastmail__mark_email_read
    - tool: mcp_fastmail__mark_email_unread
    - tool: mcp_fastmail__bulk_mark_read
    # Phase 5: Browse trusted domains (notify instead of require-approval)
    # browse_web on untrusted domains falls through to require-approval

  requireApproval:
    - tool: write_file
      conditions:
        path: "!(/sandbox/**)"    # Anywhere outside sandbox
    - tool: run_shell_command
      conditions:
        working_directory: "!(/sandbox/**)"
    # Phase 5: All outgoing actions always require approval
    - tool: send_email
    - tool: reply_email
    - tool: create_event
    - tool: update_event
    - tool: create_issue
    - tool: create_pr
    # Phase 5: Web browsing (default tier — all browse_web calls)
    - tool: browse_web
    # Phase 8: Fastmail MCP — mutating operations always require approval
    - tool: mcp_fastmail__send_email
    - tool: mcp_fastmail__delete_email
    - tool: mcp_fastmail__bulk_delete_emails
    - tool: mcp_fastmail__move_email
    - tool: mcp_fastmail__bulk_move_emails
    - tool: mcp_fastmail__create_calendar_event

# Domains trusted for web browsing.
# browse_web calls to these domains use the "notify" tier instead of "require-approval".
trustedDomains:
  - github.com
  - docs.anthropic.com
  - stackoverflow.com
  - en.wikipedia.org
  - developer.mozilla.org

# Heartbeat schedules — proactive agent triggers.
# Each heartbeat creates a new session with the specified prompt.
# HITL approval still applies for any dangerous actions.
heartbeats:
  - name: morning-briefing
    schedule: "0 8 * * 1-5"        # 8am weekdays
    prompt: "Give me a brief morning summary: any important emails from overnight, calendar events for today, and any ongoing task updates."
    enabled: true

  - name: email-check
    schedule: "*/30 * * * *"        # Every 30 minutes
    prompt: "Check my email for anything urgent or time-sensitive. Only message me if there's something that needs attention."
    enabled: false                   # Disabled by default

# GitHub repos owned by the user (read_file_github auto-approves for these).
ownGitHubRepos: []
  # - yourusername/yourrepo

# MCP server configurations (optional).
# Each MCP server runs in its own Docker container with strict security controls.
# Tools are prefixed with "mcp_{name}__" to avoid collisions with built-in tools.
#
# Servers with allowedDomains get proxied network access through the Gateway's
# domain-filtering forward proxy. Servers without allowedDomains run with
# --network=none (no network access at all).
#
# Environment variables: values set to "from_env" are resolved from the Gateway's
# process.env at container start time. Never put secrets directly in this file.
mcpServers:
  - name: fastmail
    image: secureclaw-executor-mcp
    command: npx
    args: ["--yes", "github:MadLlama25/fastmail-mcp", "fastmail-mcp"]
    env:
      FASTMAIL_API_TOKEN: from_env
      FASTMAIL_BASE_URL: "https://api.fastmail.com"
    transport: stdio
    allowedDomains:
      - api.fastmail.com
      # npm infrastructure — needed for npx to download the MCP server package.
      # These are read-only registries; the MCP server cannot exfiltrate through them.
      - registry.npmjs.org
      - github.com
      - codeload.github.com
      - objects.githubusercontent.com
    defaultTier: require-approval
    maxTools: 30

  # Example: GitHub MCP server (needs network)
  # - name: github
  #   image: secureclaw-executor-mcp
  #   command: npx
  #   args: ["-y", "@modelcontextprotocol/server-github"]
  #   env:
  #     GITHUB_PERSONAL_ACCESS_TOKEN: from_env
  #   transport: stdio
  #   allowedDomains:
  #     - api.github.com
  #     - github.com
  #   defaultTier: require-approval
  #   maxTools: 20
  #
  # Example: Filesystem MCP server (no network)
  # - name: filesystem
  #   image: secureclaw-executor-mcp
  #   command: npx
  #   args: ["-y", "@modelcontextprotocol/server-filesystem", "/workspace"]
  #   transport: stdio
  #   mounts:
  #     - name: workspace
  #       hostPath: ~/projects
  #       containerPath: /workspace
  #       readOnly: true
  #   defaultTier: auto-approve

# OAuth service configurations (optional).
# Set client ID and secret for each service you want to connect.
# oauth:
#   google:
#     clientId: your-google-client-id
#     clientSecret: your-google-client-secret
#     callbackPort: 9876
#   github:
#     clientId: your-github-client-id
#     clientSecret: your-github-client-secret
#     callbackPort: 9876
#   openaiCodex:
#     # Find the current clientId in OpenAI Codex source (CLIENT_ID):
#     # https://github.com/openai/codex/blob/main/codex-rs/core/src/auth.rs
#     clientId: your-openai-oauth-client-id
#     callbackPort: 1455
#     issuer: https://auth.openai.com
#     loginTimeoutSeconds: 600
